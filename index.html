<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Armonía de las Esferas - Jeopardy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuración de Tailwind 
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'space-dark': '#0d0d1a',
                        'space-blue': '#1a202c',
                        'brand-orange': '#f75b0f', 
                        'trivia-teal': '#00c7b5',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    animation: {
                        fadeInUp: 'fadeInUp 0.5s ease-out forwards',
                    }
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        /* ====== ESTILOS BASE ====== */
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #0d0d1a; color: white; }
        canvas { display: block; touch-action: none; }
        .point-cell:not(.answered):hover { transform: scale(1.05); background-color: #14b8a6; }
        .answered { opacity: 0.5; cursor: default; }
        #questionDisplay { background-color: white; color: #1f2937; min-height: 20rem; }
        .trivia-option-button { color: #1f2937; }
        .trivia-option-button:hover:not(:disabled) { background-color: #fcd34d !important; }
        #planetCatalog { z-index: 10; }
        .catalog-item { cursor: grab; user-select: none; transition: transform 0.1s; }
        .catalog-item.dragging { cursor: grabbing; transform: scale(1.1); opacity: 0.8; box-shadow: 0 0 20px rgba(255, 255, 255, 0.5); z-index: 50; }
        #messageBox { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); z-index: 100; padding: 10px 20px; border-radius: 8px; font-weight: bold; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); animation: fadeInUp 0.3s ease-out forwards; }
        
        /* Ajuste: quitamos .active en el HTML, pero mantenemos la transición */
        #infoPanel { position: fixed; bottom: 0; left: 0; right: 0; background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(5px); border-top: 1px solid rgba(255, 255, 255, 0.1); z-index: 11; padding: 1rem; color: white; opacity: 0; transition: opacity 0.5s, transform 0.3s; }
        #infoPanel.active { opacity: 1; }
        
        @keyframes fadeInUp { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }

        /* ****************************************************** */
        /* ====== OPTIMIZACIÓN MÓVIL (max-width: 768px) ====== */
        /* ****************************************************** */
        @media (max-width: 768px) {
            
            /* 1. Catálogo de Planetas (Fondo): Altura 100px */
            #planetCatalog {
                bottom: 0; top: auto; width: 100%; height: 100px; 
                flex-direction: row; overflow-x: auto; overflow-y: hidden; 
                padding: 0.5rem; background-color: rgba(0, 0, 0, 0.9); z-index: 40; 
                justify-content: flex-start; 
            }
            #planetCatalog p { display: none; }
            #catalogList { display: flex; gap: 1rem; }
            .catalog-item { width: 80px; font-size: 0.75rem; flex-direction: column; }
            .catalog-item > div:last-child { margin-left: 0 !important; margin-top: 0.3rem; font-size: 0.7rem; }


            /* 2. Panel de Información (#infoPanel): Posicionado encima del catálogo (100px) */
            #infoPanel {
                bottom: 100px; 
                padding: 0.5rem; 
                z-index: 30; 
                flex-direction: column; 
                align-items: flex-start;
                transition: transform 0.3s; 
            }

            #infoContent {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
            
            #infoPanel .w-full.sm\:w-1\/2.flex { 
                width: 100%;
                margin-bottom: 0.5rem;
            }
            #infoName { font-size: 1.25rem !important; }
            #infoFact { font-size: 0.7rem; }

            /* Datos Clave (Mitad inferior): Forzar 2 columnas */
            #infoPanel .w-full.sm\:w-1\/2.grid {
                width: 100%;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5rem;
                font-size: 0.7rem;
                text-align: center;
                margin-top: 0.5rem;
            }
            #infoPanel .col-span-2 { grid-column: span 1 / span 1 !important; }

            /* 3. Controles Flotantes (#controls): POSICIÓN MOVIDA A LA PARTE SUPERIOR */
            #controls {
                bottom: auto !important; 
                top: 0.5rem !important; 
                left: 50%; 
                transform: translateX(-50%);
                flex-direction: row !important; 
                z-index: 35;
                background-color: transparent; 
                padding: 0.5rem;
                width: 100%;
                max-width: 400px; 
                justify-content: space-evenly;
            }

            #controls button {
                font-size: 0.8rem;
                padding: 0.6rem 1.2rem;
                flex-grow: 1; 
            }
            
            #controls div.sm\:ml-8 {
                margin-left: 0 !important;
            }

            /* Estilos del tablero Jeopardy */
            #triviaContent { padding: 0.5rem; }
            #jeopardyBoard { grid-template-columns: repeat(3, 1fr) !important; gap: 0.3rem !important; }
            #jeopardyBoard > div:first-child, #jeopardyBoard > div:nth-child(2), #jeopardyBoard > div:nth-child(3) { font-size: 0.8rem !important; height: 40px; }
            .point-cell { font-size: 1rem !important; padding: 0.8rem 0.2rem !important; }
            
            /* Pantalla Final (CORRECCIÓN DE TÍTULO PARA EVITAR DESBORDAMIENTO) */
            #finalScoreOverlay h2 { font-size: 2rem !important; line-height: 1.1; }
            #finalScoreOverlay p { font-size: 0.9rem !important; padding-left: 0.5rem; padding-right: 0.5rem; }
            #finalScoreOverlay p.text-6xl { font-size: 2.5rem !important; line-height: 1.1; margin-top: 1rem; margin-bottom: 1.5rem; }
            #finalScoreOverlay .bg-white { padding: 1.5rem !important; max-width: 90%; }
            #finalScoreOverlay button { font-size: 1rem !important; padding: 0.8rem 1.2rem !important; }

            /* Estilos para la tarjeta de pregunta de Trivia */
            #currentQuestionText { font-size: 1.25rem !important; line-height: 1.3; margin-bottom: 1rem; }
            #questionDisplay { min-height: auto !important; padding: 1rem !important; }
            #feedbackMessage { font-size: 1rem !important; margin-top: 1rem; }
        }
    </style>
    </head>
<body>

    <div id="container"></div>
    
    <div id="messageBox" class="hidden"></div>

    <audio id="backgroundMusic" loop>
        <source src="audioorbita_sound.mp3" type="audio/mp3">
        Tu navegador no soporta el elemento de audio.
    </audio> 
    <div id="overlay" style="background-color: #f75b0f;" class="fixed inset-0 flex flex-col items-center justify-center p-4 text-white transition-opacity duration-500 ease-in-out z-30">
        <div class="flex flex-col items-center text-center p-4">
            
            <h1 class="text-6xl sm:text-7xl font-extrabold mb-12 text-white uppercase tracking-wider">
                Armonía de las Esferas
            </h1>
            
            </div>
    </div>
    
    <div id="planetCatalog" class="fixed right-0 top-0 h-full w-48 bg-gray-900/70 backdrop-blur-sm p-4 space-y-4 flex flex-col items-center justify-start pt-4 pb-48 overflow-y-auto z-10 opacity-0 transition-opacity duration-500 pointer-events-none">
        
        <p class="text-lg text-gray-400 mb-4">Arrastra para crear órbita.</p>
        
        <div id="catalogList" class="space-y-4 w-full">
            </div>
    </div>

    <div id="controls" class="fixed inset-x-0 top-4 flex justify-center items-center gap-4 z-20 opacity-0 transition-opacity duration-500 pointer-events-none p-2 sm:top-4">
        
        <button id="clearButton" style="background-color: #f75b0f;" 
            class="px-5 py-3 hover:bg-orange-700 text-white font-semibold rounded-full shadow-lg transition transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-orange-500 focus:ring-opacity-50">
            Reiniciar Simulación
        </button>
        
        <button id="triviaButton" 
            class="px-5 py-3 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold rounded-full shadow-lg transition transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-yellow-400 focus:ring-opacity-50">
            Iniciar Trivia
        </button>

        <button id="pauseButton" class="hidden" onclick="togglePause()"></button>
    </div>

    <div id="infoPanel" class="opacity-0">
        <div id="infoContent" class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-8">
            <div class="w-full sm:w-1/2 flex items-center space-x-4">
                <div id="infoSphere" class="flex-shrink-0 w-8 h-8 rounded-full border border-white"></div>
                <div class="flex-grow">
                    <h3 id="infoName" class="text-3xl font-extrabold text-white">Ningún Planeta Activo</h3>
                    <p id="infoFact" class="text-sm text-gray-400 mt-1">Arrastra un planeta del catálogo para empezar.</p>
                </div>
            </div>
            
            <div class="w-full sm:w-1/2 grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm font-semibold">
                
                <div class="flex flex-col col-span-1">
                    <span class="text-yellow-400">DISTANCIA DEL SOL</span>
                    <span id="infoDistance" class="text-white">N/A</span>
                </div>

                <div class="flex flex-col col-span-1">
                    <span class="text-yellow-400">PERIODO ORBITAL</span>
                    <span id="infoPeriod" class="text-white">N/A</span>
                </div>
                
                <div class="flex flex-col col-span-1">
                    <span class="text-yellow-400">COMPOSICIÓN</span>
                    <span id="infoComposition" class="text-white">N/A</span>
                </div>
                
                <div class="flex flex-col col-span-1">
                    <span class="text-yellow-400" id="massLabel">MASA (kg)</span>
                    <span id="infoMass" class="text-white">N/A</span>
                </div>
            </div>
        </div>
    </div>


    <div id="jeopardyOverlay" style="background-color: #f75b0f;" class="fixed inset-0 flex flex-col items-center justify-center p-4 text-white z-40 hidden">
        <div id="triviaContent" class="w-full max-w-6xl bg-gray-900/90 rounded-xl shadow-2xl p-6 space-y-6">
            
            <div class="flex justify-between items-center border-b pb-3 border-gray-700">
                <h2 class="text-3xl font-bold text-yellow-400">Armonía de las Esferas</h2>
                <div id="score" class="text-lg font-medium bg-gray-800 p-2 rounded-lg">
                    Puntos: <span id="currentScore" class="text-yellow-400">0</span>
                </div>
                <button id="resumeButton" class="px-4 py-2 bg-trivia-teal hover:bg-teal-600 rounded-lg text-white font-semibold transition">Regresar</button>
            </div>
            
            <div id="jeopardyBoard" class="grid grid-cols-3 gap-3">
                <div class="p-3 bg-trivia-teal font-extrabold text-xl text-center rounded-t-lg text-white">CERCANOS</div>
                <div class="p-3 bg-trivia-teal font-extrabold text-xl text-center rounded-t-lg text-white">GIGANTES</div>
                <div class="p-3 bg-trivia-teal font-extrabold text-xl text-center rounded-t-lg text-white">CARACTERÍSTICAS</div>
                
                </div>
            
            <div id="questionDisplay" class="hidden flex-col justify-center items-center p-6 bg-white text-gray-900 rounded-lg question-card">
                <div id="questionCategory" class="text-xl font-semibold text-yellow-600 mb-2"></div>
                <div id="questionValue" class="2xl font-bold mb-4"></div>
                <div id="currentQuestionText" class="text-2xl text-center mb-6"></div>
                
                <div id="optionsContainer" class="w-full grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
                
                <div id="feedbackMessage" class="mt-4 text-xl font-bold hidden"></div>
                <button id="backToBoardButton" class="mt-6 px-6 py-3 bg-trivia-teal hover:bg-teal-600 rounded-lg text-white font-semibold transition hidden">Volver al Tablero</button>
            </div>
            

        </div>
    </div>
    
    <div id="finalScoreOverlay" style="background-color: #f75b0f;" class="fixed inset-0 flex flex-col items-center justify-center p-6 text-white z-50 hidden">
        <div class="bg-white p-10 rounded-xl text-center shadow-2xl max-w-lg w-full">
            <h2 class="text-5xl font-extrabold text-gray-900 mb-4">¡JUEGO TERMINADO!</h2>
            <p class="text-xl text-gray-700 mb-6">Has respondido las 5 preguntas.</p>
            <p class="text-6xl font-black text-brand-orange mb-8">Puntuación Final: $<span id="finalScoreValue">0</span></p>
            <button id="returnToSimButton" class="px-8 py-4 bg-trivia-teal hover:bg-teal-600 text-white font-bold rounded-lg shadow-lg transition transform hover:scale-105">
                Volver a la Simulación
            </button>
        </div>
    </div>

    <script>
        // =================================================================
        // FUNCIÓN DE MENSAJES (Definida de forma global y segura)
        // =================================================================

        let messageTimeout;

        /**
         * Muestra mensajes flotantes al usuario.
         */
        function showMessage(message, duration, color) {
            clearTimeout(messageTimeout); 
            const messageBox = document.getElementById('messageBox');
            
            if (!messageBox) return;

            const hexColor = color ? '#' + color.getHexString() : '#22c55e';
            const textColor = color ? (color.getHSL({}).l > 0.5 ? 'black' : 'white') : 'white';

            messageBox.textContent = message;
            messageBox.style.backgroundColor = hexColor;
            messageBox.style.color = textColor;
            messageBox.classList.remove('hidden');

            messageTimeout = setTimeout(() => {
                messageBox.classList.add('hidden');
            }, duration);
        }

        // =================================================================
        // ESTRUCTURA DE DATOS DEL SISTEMA SOLAR REAL (Catálogo)
        // ** MODIFICADO: Se añade 'massKg' con la masa en kilogramos (notación científica). **
        // =================================================================

        const M_TIERRA = 5.9722e24; // 5.9722 x 10^24 kg
        
        const SOLAR_SYSTEM_PLANETS = [
            // SOL
            { 
                name: 'Sol', color: 0xffa500, radius: 25.0, massFactor: 1000.0, isSun: true, 
                fact: 'La estrella central, responsable de la gravedad en el sistema. Emite luz intensa.',
                distance: '0 km', period: 'N/A', composition: 'Hidrógeno y Helio',
                massKg: 1.989x10^30 // Masa del Sol en kg
            },
            // PLANETAS (massKg en kg | massFactor en relación a la Tierra para la física)
            { 
                name: 'Mercurio', color: 0x9f9e9e, radius: 4.725, massFactor: 0.0553, isSun: false, 
                fact: 'El planeta más pequeño de nuestro sistema solar y el más cercano al Sol',
                distance: '58 millones km', period: '88 días', composition: 'Roca y Metales (Hierro)',
                massKg: 3.3011x10^23 // 3.3011 x 10^23 kg
            },
            { 
                name: 'Venus', color: 0xe68a00, radius: 8.82, massFactor: 0.815, isSun: false, 
                fact: 'El planeta más caliente con una atmósfera tóxica de Dióxido de Carbono y nubes de ácido sulfúrico.',
                distance: '108 millones km', period: '225 días', composition: 'Roca fundida y Nubes de Ácido Sulfúrico',
                massKg: 4.8675x10^24 // 4.8675 x 10^24 kg (¡Tu ejemplo!)
            },
            { 
                name: 'Tierra', color: 0x0077be, radius: 9.45, massFactor: 1.0, isSun: false, 
                fact: 'Nuestro planeta hogar, el único mundo conocido con océanos de agua líquida y vida.',
                distance: '150 millones km', period: '365 días', composition: 'Silicatos, Hierro, Níquel',
                massKg: 5.9722x10^24 // 5.9722 x 10^24 kg
            },
            { 
                name: 'Marte', color: 0xc1440e, radius: 6.3, massFactor: 0.107, isSun: false, 
                fact: 'El planeta rojo con casquetes polares de hielo y evidencia de antiguos ríos y lagos.',
                distance: '228 millones km', period: '687 días', composition: 'Roca Volcánica y Óxidos de Hierro',
                massKg: 6.4169x10^23 // 6.4169 x 10^23 kg
            },
            { 
                name: 'Júpiter', color: 0xe0c38c, radius: 26.775, massFactor: 317.8, isSun: false, 
                fact: 'El planeta más grande de nuestro sistema solar con una distintiva Gran Mancha Roja',
                distance: '778 millones km', period: '12 años', composition: 'Hidrógeno y Helio (Gaseoso)',
                massKg: 1.8982x10^27 // 1.8982 x 10^27 kg
            },
            { 
                name: 'Saturno', color: 0xe0e0c3, radius: 23.625, massFactor: 95.2, isSun: false, 
                fact: 'Famoso por su espectacular sistema de anillos compuestos principalmente de partículas de hielo.',
                distance: '1429 millones km', period: '29.5 años', 'composition': 'Hidrógeno, Helio y Hielo (Gaseoso)',
                massKg: 5.6834x10^26 // 5.6834 x 10^26 kg
            },
            { 
                name: 'Urano', color: 0x82b3c9, radius: 18.9, massFactor: 14.5, isSun: false, 
                fact: 'Un gigante de hielo que rota sobre su lado, con un color azul-verdoso debido al metano.',
                distance: '2871 millones km', period: '84 años', composition: 'Hielo, Metano y Roca',
                massKg: 8.6810x10^25 // 8.6810 x 10^25 kg
            },
            { 
                name: 'Neptuno', color: 0x006699, radius: 18.9, massFactor: 17.1, isSun: false, 
                fact: 'El planeta más ventoso con las tormentas más fuertes en el sistema solar.',
                distance: '4500 millones km', period: '165 años', composition: 'Hielo, Amoniaco y Metano',
                massKg: 1.0241x10^26 // 1.0241 x 10^26 kg
            },
        ];

        // =================================================================
        // DECLARACIÓN DE VARIABLES GLOBALES 
        // =================================================================
        let scene, camera, renderer;
        let ambientLight;
        let starField; 
        let dragObject = null; 
        let dragTarget = null; 
        
        const suns = []; 
        const planets = [];
        
        let isPaused = false;
        
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();
        const tempVector = new THREE.Vector3();
        
        let isDragging = false; 
        let isPointerActive = false;
        let pointerStart = { x: 0, y: 0 };
        let previousPointerPosition = { x: 0, y: 0 };
        const ORBIT_RADIUS = 400; 
        
        let theta = 0.5; 
        let phi = Math.PI / 2;
        
        let velocityX = 0;
        let velocityY = 0;
        
        // Audio (simplificado al máximo) - SÓLO DUMMY
        let isAudioContextStarted = false;
        let musicStarted = false;

        // Constantes de Física/Visuales
        const GRAVITATIONAL_CONSTANT = 2.5; 
        const SUN_MASS = 1000.0; 
        const PLANET_MASS = 1.0; 
        const TIME_STEP = 0.02; 
        const COLLISION_DISTANCE = 18; 
        const MAX_SUN_DISTANCE = 100; 
        const MAX_EXPULSION_DISTANCE = 1000;
        const TRAIL_LENGTH = 100; 
        const DRAG_THRESHOLD = 5;
        const ROTATION_MULTIPLIER = 0.005;
        const DAMPING_FACTOR = 0.9; 

        // Estructura de Capas (Dummy, para la estructura de planetas)
        const TRACKS_PER_SONG = 1;
        const INSTRUMENT_LAYERS = ['Pista Visual'];
        let activePatterns = {}; 

        // Trivia
        let currentScore = 0; 
        const JEOPARDY_POINTS = [100, 200, 300, 400, 500];
        // Nombres de categoría utilizados en el JS para que coincidan con el HTML móvil
        const JEOPARDY_CATEGORIES = {
            'CERCANOS': 'CERCANOS', 
            'GIGANTES': 'GIGANTES', 
            'EXTREMAS': 'CARACTERÍSTICAS' 
        };
        let answeredQuestions = {}; 
        let availableQuestions = {}; 
        let activeQuestion;
        const MAX_QUESTIONS = 5;
        let questionsAnswered = 0;


        // =================================================================
        // DEFINICIÓN DE PREGUNTAS DE JEOPARDY 
        // =================================================================
        
        const JEOPARDY_QUESTIONS = [
            // COLUMNA 1: PLANETAS CERCANOS AL SOL
            { category: 'CERCANOS', points: 100, question: '¿Cuál es el planeta más cercano al Sol?', answer: 'Mercurio', options: ['Venus', 'Marte', 'Mercurio', 'Tierra'] },
            { category: 'CERCANOS', points: 200, question: '¿Cuál es el planeta con casquetes polares de hielo y evidencia de antiguos ríos y lagos?', answer: 'Marte', options: ['Venus', 'Mercurio', 'Tierra', 'Marte'] },
            { category: 'CERCANOS', points: 300, question: '¿Qué planeta tiene una atmósfera tóxica de Dióxido de Carbono y nubes de ácido sulfúrico??', answer: 'Venus', options: ['Marte', 'Venus', 'Tierra', 'Mercurio'] },
            { category: 'CERCANOS', points: 400, question: '¿Cuál es el único planeta con vida conocida?', answer: 'Tierra', options: ['Tierra', 'Marte', 'Venus', 'Mercurio'] },
            { category: 'CERCANOS', points: 500, question: '¿Cuál es conocido como “el planeta rojo”?', answer: 'Marte', options: ['Mercurio', 'Tierra', 'Marte', 'Venus'] },

            // COLUMNA 2: GIGANTES DEL SISTEMA SOLAR
            { category: 'GIGANTES', points: 100, question: '¿Cuál es el planeta más grande de nuestro sistema solar?', answer: 'Júpiter', options: ['Saturno', 'Júpiter', 'Urano', 'Neptuno'] },
            { category: 'GIGANTES', points: 200, question: '¿Cuál es el nombre del planeta que rota de lado por su inclinación axial de 98 grados, y tiene un color azul-verdoso por el metano?', answer: 'Urano', options: ['Júpiter', 'Saturno', 'Urano', 'Neptuno'] },
            { category: 'GIGANTES', points: 300, question: '¿Cuál es el planeta famoso por su sistema de anillos de partículas de hielo, polvo y roca?', answer: 'Saturno', options: ['Urano', 'Saturno', 'Neptuno', 'Júpiter'] },
            { category: 'GIGANTES', points: 400, question: '¿Cuál es el planeta conocido con océanos de agua líquida?', answer: 'Tierra', options: ['Saturno', 'Tierra', 'Júpiter', 'Neptuno'] },
            { category: 'GIGANTES', points: 500, question: '¿Cuál es el periodo orbital del planeta Tierra?', answer: '365 días', options: ['365 días', '356 días', '120 días', '88 días'] },

            // COLUMNA 3: CARACTERÍSTICAS EXTREMAS
            { category: 'EXTREMAS', points: 100, question: '¿Cuál es el planeta más caliente del sistema solar cuya temperatura oscila en los 464 grados centígrados?', answer: 'Venus', options: ['Mercurio', 'Venus', 'Tierra', 'Júpiter'] },
            { category: 'EXTREMAS', points: 200, question: '¿Qué planeta es famoso por tener anillos visibles?', answer: 'Saturno', options: ['Urano', 'Neptuno', 'Saturno', 'Júpiter'] },
            { category: 'EXTREMAS', points: 300, question: '¿Cuál de estos planetas presenta las tormentas más fuertes?', answer: 'Neptuno', options: ['Urano', 'Saturno', 'Neptuno', 'Marte'] },
            { category: 'EXTREMAS', points: 400, question: '¿Cuál es el planeta que tiene un periodo orbital de 88 días?', answer: 'Mercurio', options: ['Saturno', 'Mercurio', 'Neptuno', 'Júpiter'] },
            { category: 'EXTREMAS', points: 500, question: '¿Cuál es el planeta que tiene una distancia del Sol de 4.495 billones km?', answer: 'Neptuno', options: ['Saturno', 'Neptuno', 'Urano', 'Júpiter'] }
        ];

        // =================================================================
        // DECLARACIÓN DE FUNCIONES GLOBALES 
        // =================================================================
        
        function updateAudioVolumes() { /* Audio eliminado */ }
        function setupBackgroundAudio() { /* Audio eliminado */ }
        function toggleMusic(shouldPlay) { /* Audio eliminado */ }
        function startAudioContext() { /* Audio eliminado */ }
        function createSynth() { return { synth: null, panner: null }; }
        function changeSong() { showMessage(`¡Sistema Solar Ampliado!`, 2000, new THREE.Color(0xfacc15)); }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function calculateGravity(planet) {
            const netAcceleration = new THREE.Vector3(0, 0, 0);
            suns.forEach(sun => {
                const direction = tempVector.copy(sun.mesh.position).sub(planet.mesh.position);
                const distanceSq = direction.lengthSq();
                if (distanceSq < 1) { return; }
                const distance = Math.sqrt(distanceSq);
                const magnitude = (GRAVITATIONAL_CONSTANT * sun.mass) / distanceSq; 
                const finalMagnitude = Math.min(magnitude, 5.0);
                direction.normalize().multiplyScalar(finalMagnitude);
                netAcceleration.add(direction);
            });
            planet.acceleration = netAcceleration;
        }

        function updatePhysics(planet, deltaTime) {
            planet.velocity.add(planet.acceleration.clone().multiplyScalar(deltaTime));
            planet.mesh.position.add(planet.velocity.clone().multiplyScalar(deltaTime));
        }

        function findNearestSun(clickPosition) {
            let minDistanceSq = Infinity;
            let nearestSun = null;
            suns.forEach(sun => {
                const diffVector = new THREE.Vector3().subVectors(sun.mesh.position, clickPosition);
                const distanceSq = diffVector.lengthSq(); 
                if (distanceSq < minDistanceSq) {
                    minDistanceSq = distanceSq;
                    nearestSun = sun;
                }
            });
            return nearestSun;
        }
        
        // ** FUNCIÓN MODIFICADA: Ahora usa 'massKg' y formatea a notación científica **
        function updateInfoPanel(planetData) {
            document.getElementById('infoPanel').classList.add('active');
            
            document.getElementById('infoName').textContent = planetData.name || 'Ningún Planeta Activo';
            document.getElementById('infoFact').textContent = planetData.fact || 'Arrastra un planeta del catálogo para empezar.';
            
            const colorHex = planetData.color ? '#' + new THREE.Color(planetData.color).getHexString() : '#333333';
            document.getElementById('infoSphere').style.backgroundColor = colorHex;
            
            document.getElementById('infoDistance').textContent = planetData.distance || 'N/A';
            document.getElementById('infoPeriod').textContent = planetData.period || 'N/A';
            document.getElementById('infoComposition').textContent = planetData.composition || 'N/A';
            
            // Lógica para mostrar la masa en kg (notación científica)
            const massValue = planetData.massKg; 
            let formattedMass;
            
            if (typeof massValue === 'number' && massValue > 0) {
                // toExponential(4) fuerza 4 decimales: X.XXXXe+YY. Reemplazamos 'e+' por 'e'
                formattedMass = massValue.toExponential(4).replace('e+', 'e');
            } else {
                // Si no hay massKg (ej: Sol inicial), usamos el massFactor para la física si es > 0, sino N/A
                formattedMass = planetData.massFactor > 0 ? (planetData.massFactor * M_TIERRA).toExponential(4).replace('e+', 'e') : 'N/A';
            }

            document.getElementById('infoMass').textContent = formattedMass;
            document.getElementById('massLabel').textContent = 'MASA (kg)'; // Asegura que la etiqueta es correcta
        }

        function createSunAtPosition(position) {
            const sunData = SOLAR_SYSTEM_PLANETS.find(p => p.name === 'Sol');
            const sunRadius = sunData ? sunData.radius : 25.0; 
            const sunMass = sunData ? sunData.massFactor * SUN_MASS : 1000.0;
            
            if (suns.length > 0 && suns[0].name === 'Sol' && suns[0].mesh.position.distanceTo(new THREE.Vector3(5, 0, 0)) < 1) {
                scene.remove(suns[0].mesh);
                scene.remove(suns[0].light);
                suns.shift(); 
            }
            
            const sunGeometry = new THREE.SphereGeometry(sunRadius, 32, 32); 
            const sunMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xff9900, 
                emissive: 0xff9900 
            }); 
            const sunMesh = new THREE.Mesh(sunGeometry, sunMaterial);
            sunMesh.position.copy(position);
            scene.add(sunMesh);
            
            const flareTexture = generateRadialTexture(); 
            const lightSprite = new THREE.Sprite(new THREE.SpriteMaterial({
                map: flareTexture, 
                color: 0xff8800, 
                blending: THREE.AdditiveBlending, 
                transparent: true, 
                opacity: 0.8 
            }));
            lightSprite.scale.set(80, 80, 1.0); 
            sunMesh.add(lightSprite);

            const sunLight = new THREE.PointLight(0xffffff, 5.0, 0, 0); 
            sunLight.position.copy(position);
            scene.add(sunLight);

            // Se añade massKg
            suns.push({ mesh: sunMesh, light: sunLight, mass: sunMass, name: 'Sol', fact: sunData.fact, distance: sunData.distance, period: sunData.period, composition: sunData.composition, massFactor: sunData.massFactor, massKg: sunData.massKg });
            
            updateInfoPanel(sunData); 
            
            if (suns.length > 1 && musicStarted) {
                changeSong();
            }
        }
        
        function createStarField() {
            const starCount = 1500;
            const starGeometry = new THREE.BufferGeometry();
            const positions = [];
            const radius = 500; 
            for (let i = 0; i < starCount; i++) {
                const x = THREE.MathUtils.randFloatSpread(radius * 2);
                const y = THREE.MathUtils.randFloatSpread(radius * 2);
                const z = THREE.MathUtils.randFloatSpread(radius * 2);
                positions.push(x, y, z);
            }
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 1, sizeAttenuation: true });
            starField = new THREE.Points(starGeometry, starMaterial);
            scene.add(starField);
        }
        
        function generateRadialTexture() {
            const size = 128;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const context = canvas.getContext('2d');
            const gradient = context.createRadialGradient(size / 2, size / 2, 0, size / 2, size / 2, size / 2 );
            gradient.addColorStop(0, 'rgba(255,255,255,1)'); 
            gradient.addColorStop(1, 'rgba(255,255,255,0)'); 
            context.fillStyle = gradient;
            context.fillRect(0, 0, size, size);
            return new THREE.CanvasTexture(canvas);
        }
        
        function createInitialSun() {
            const center = new THREE.Vector3(5, 0, 0); 
            createSunAtPosition(center);
        }
        
        function setupPointerControls(element) {
            element.addEventListener('pointerdown', onPointerDown, false);
            element.addEventListener('pointermove', onPointerMove, false);
            element.addEventListener('pointerup', onPointerUp, false);
            element.addEventListener('pointerleave', onPointerUp, false);
            element.style.touchAction = 'none'; 
        }

        function onPointerDown(event) {
            if (event.buttons === 1 || event.pointerType === 'touch') { 
                isPointerActive = true; 
                isDragging = false; 
                
                pointerStart.x = event.clientX;
                pointerStart.y = event.clientY;

                previousPointerPosition.x = event.clientX;
                previousPointerPosition.y = event.clientY;
                velocityX = 0;
                velocityY = 0;
            }
        }

        function onPointerMove(event) {
            
            if (!isPointerActive) return; 

            if (event.pointerType === 'touch' && touchTarget) return; 

            if (!isDragging) {
                const deltaMovementX = event.clientX - pointerStart.x;
                const deltaMovementY = event.clientY - pointerStart.y;
                const distance = Math.sqrt(deltaMovementX * deltaMovementX + deltaMovementY * deltaMovementY); 
                
                if (distance > DRAG_THRESHOLD) {
                    isDragging = true; 
                }
            }

            if (isDragging) { 
                const deltaX = event.clientX - previousPointerPosition.x;
                const deltaY = event.clientY - previousPointerPosition.y;

                theta += deltaX * ROTATION_MULTIPLIER;
                phi -= deltaY * ROTATION_MULTIPLIER;
                
                velocityX = deltaX * ROTATION_MULTIPLIER * 0.5;
                velocityY = deltaY * ROTATION_MULTIPLIER * 0.5;

                previousPointerPosition.x = event.clientX;
                previousPointerPosition.y = event.clientY;
            }
        }

        function onPointerUp(event) {
            if (event.pointerType !== 'touch' && isPointerActive && !isDragging) { 
                const entitySelect = document.getElementById('entitySelect');
                const selectedEntity = entitySelect ? entitySelect.value : 'planet';
                
                if (dragTarget && (dragTarget.isSun || selectedEntity === 'sun')) {
                    createSunOnClick(event); 
                }
            }
            
            isDragging = false; 
            isPointerActive = false; 
        }

        function updateDragObjectPosition(event) {
            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = - (event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(pointer, camera);
            const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
            const intersection = new THREE.Vector3();
            if (raycaster.ray.intersectPlane(plane, intersection) && dragObject) {
                dragObject.position.copy(intersection);
            }
        }
        
        function createPlanetFromCatalog(event, planetData) {
            if (suns.length === 0) {
                showMessage('No hay soles para orbitar. ¡Crea un Sol primero!', 3000, new THREE.Color(0xef4444));
                return;
            }
            
            if (planetData.isSun) {
                createSunOnClick(event);
                return;
            }

            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = - (event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(pointer, camera);
            const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
            const intersection = new THREE.Vector3();
            raycaster.ray.intersectPlane(plane, intersection);
            const initialPosition = intersection.clone();
            const nearestSun = findNearestSun(initialPosition);
            const relativePosition = initialPosition.clone().sub(nearestSun.mesh.position);
            const distance = relativePosition.length();
            if (distance < COLLISION_DISTANCE) {
                showMessage('Demasiado cerca del Sol. Intenta más lejos.', 3000, new THREE.Color(0xfacc15));
                return;
            }
            const massForOrbit = planetData.massFactor * PLANET_MASS; 
            const orbitVelocityMag = Math.sqrt((GRAVITATIONAL_CONSTANT * nearestSun.mass) / distance);
            const positionUnit = relativePosition.clone().normalize();
            let initialVelocity = new THREE.Vector3().crossVectors(positionUnit, new THREE.Vector3(0, 1, 0));
            if (initialVelocity.lengthSq() < 0.001) {
                    initialVelocity.set(1, 0, 0); 
            }
            
            initialVelocity.normalize().multiplyScalar(orbitVelocityMag * THREE.MathUtils.randFloat(0.32, 0.38));

            initialVelocity.y = THREE.MathUtils.randFloatSpread(orbitVelocityMag * 0.1); 
            const brightColor = new THREE.Color(planetData.color);
            const planetGeometry = new THREE.SphereGeometry(planetData.radius, 32, 32);
            const planetMaterial = new THREE.MeshLambertMaterial({ 
                color: brightColor, 
                emissive: brightColor.clone().multiplyScalar(0.1) 
            });
            const planetMesh = new THREE.Mesh(planetGeometry, planetMaterial);
            planetMesh.position.copy(initialPosition);
            const orbitPositions = new Float32Array(TRAIL_LENGTH * 3); 
            const drawingPositions = new Float32Array(TRAIL_LENGTH * 3);
            const trailColors = new Float32Array(TRAIL_LENGTH * 4); 
            const trailGeometry = new THREE.BufferGeometry();
            trailGeometry.setAttribute('position', new THREE.BufferAttribute(drawingPositions, 3)); 
            trailGeometry.setAttribute('color', new THREE.BufferAttribute(trailColors, 4));
            const trailMaterial = new THREE.LineBasicMaterial({
                color: brightColor, 
                transparent: true,
                opacity: 1.0,
                vertexColors: true
            });
            const orbitTrail = new THREE.Line(trailGeometry, trailMaterial);
            scene.add(orbitTrail);
            const planetObject = {
                mesh: planetMesh, trail: orbitTrail, orbitPositions: orbitPositions, 
                trailColors: trailColors, planetColor: brightColor, trailIndex: 0,
                trailLength: TRAIL_LENGTH, trailCount: 0, mass: massForOrbit,
                velocity: initialVelocity, acceleration: new THREE.Vector3(0, 0, 0),
                name: planetData.name, fact: planetData.fact, id: planets.length + 1, 
                distance: planetData.distance, period: planetData.period, composition: planetData.composition,
                massFactor: planetData.massFactor,
                massKg: planetData.massKg // Propiedad añadida
            };
            scene.add(planetMesh);
            planets.push(planetObject);
            updateAudioVolumes();
            showMessage(`¡Planeta ${planetData.name} Creado!`, 1500, brightColor);
            updateInfoPanel(planetObject); 

            // Iniciar la música si es el primer planeta que se añade
            if (!musicStarted) {
                const backgroundMusic = document.getElementById('backgroundMusic');
                if (backgroundMusic) {
                    backgroundMusic.play().catch(error => {
                        console.warn("La reproducción de audio fue bloqueada por el navegador. Se requiere interacción del usuario.", error);
                        showMessage("La música no pudo iniciarse automáticamente.", 2500, new THREE.Color(0xfacc15));
                    });
                    musicStarted = true;
                }
            }
        }

        function createPlanet(event) {
            showMessage('Arrastra un planeta del catálogo para crear su órbita.', 2000, new THREE.Color(0xfacc15));
            return;
        }

        function createSunOnClick(event) {
            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = - (event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(pointer, camera);
            const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0); 
            const intersection = new THREE.Vector3();
            raycaster.ray.intersectPlane(plane, intersection);
            if (intersection.length() > MAX_SUN_DISTANCE) {
                intersection.normalize().multiplyScalar(MAX_SUN_DISTANCE);
                showMessage('Sol colocado en el límite de la zona central.', 2000, new THREE.Color(0xfacc15));
            }
            
            if (suns.length === 1 && suns[0].name === 'Sol' && suns[0].mesh.position.distanceTo(new THREE.Vector3(5, 0, 0)) < 1) {
                scene.remove(suns[0].mesh);
                scene.remove(suns[0].light);
                suns.pop(); 
            }
            
            const sunData = SOLAR_SYSTEM_PLANETS.find(p => p.name === 'Sol');
            createSunAtPosition(intersection);
            updateInfoPanel(suns[suns.length - 1]); 
            showMessage('¡Nuevo Sol Creado! Ahora afecta la gravedad.', 2000, new THREE.Color(0xfacc15));
        }
        
        function clearSimulation() {
            const initialSuns = suns.length;
            const audio = document.getElementById('backgroundMusic');
            if(audio) {
                audio.pause();
                audio.currentTime = 0;
            }
            musicStarted = false;
            planets.forEach(planet => { scene.remove(planet.mesh); scene.remove(planet.trail); });
            planets.length = 0;
            suns.forEach(sun => { scene.remove(sun.mesh); scene.remove(sun.light); });
            suns.length = 0;
            createInitialSun(); 
            updateInfoPanel(SOLAR_SYSTEM_PLANETS.find(p => p.name === 'Sol'));
            showMessage('Simulación Reiniciada. ¡Crea nuevos sistemas!', 2500, new THREE.Color(0xef4444));
        }

        function togglePause() {
            isPaused = !isPaused;
            const button = document.getElementById('pauseButton');
            
            if (isPaused) {
                button.textContent = 'Reanudar Simulación';
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
                showMessage('Simulación PAUSADA.', 1500, new THREE.Color(0xfb923c));
            } else {
                button.textContent = 'Pausar Simulación';
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                showMessage('Simulación REANUDADA.', 1500, new THREE.Color(0x22c55e));
            }
        }


        function startJeopardy() {
            if (!isPaused) {
                togglePause();
            }

            document.getElementById('jeopardyOverlay').classList.remove('hidden');
            document.getElementById('controls').style.opacity = '0';
            document.getElementById('controls').style.pointerEvents = 'none';
            document.getElementById('planetCatalog').style.opacity = '0';
            document.getElementById('planetCatalog').style.pointerEvents = 'none';


            currentScore = 0;
            questionsAnswered = 0; 
            document.getElementById('currentScore').textContent = 0;
            
            generateDynamicQuestions(); 
            renderJeopardyBoard();
        }
        
        function resumeSimulation() {
            document.getElementById('jeopardyOverlay').classList.add('hidden');
            document.getElementById('finalScoreOverlay').classList.add('hidden'); 
            
            document.getElementById('controls').style.opacity = '1';
            document.getElementById('controls').style.pointerEvents = 'auto';
            document.getElementById('planetCatalog').style.opacity = '1';
            document.getElementById('planetCatalog').style.pointerEvents = 'auto';


            if (document.getElementById('pauseButton').textContent === 'Reanudar Simulación') {
                togglePause();
            }
        }
        
        function populateCatalog() {
            const catalogList = document.getElementById('catalogList');
            catalogList.innerHTML = '';
            
            SOLAR_SYSTEM_PLANETS.forEach((planetData, index) => {
                const item = document.createElement('div');
                item.className = 'catalog-item flex items-center p-2 bg-gray-800 rounded-lg shadow-md hover:bg-gray-700 transition duration-150';
                item.draggable = false; 
                item.dataset.planetIndex = index;
                item.dataset.name = planetData.name;

                const radiusSize = planetData.isSun ? 24 : 16;
                const colorHex = '#' + new THREE.Color(planetData.color).getHexString();
                const sphere = `<div style="background-color: ${colorHex}; width: ${radiusSize}px; height: ${radiusSize}px; border-radius: 50%; border: 1px solid white;"></div>`;
                const info = `<div class="ml-3 text-lg font-semibold">${planetData.name}</div>`; 

                item.innerHTML = sphere + info;
                
                catalogList.appendChild(item);
                
                if (index === 0) {
                    updateInfoPanel(planetData);
                }
            });
            
            document.getElementById('planetCatalog').style.opacity = '1';
            document.getElementById('planetCatalog').style.pointerEvents = 'auto';

        }
        
        function generateDynamicQuestions() {
            const allQuestionsData = JEOPARDY_QUESTIONS;
            
            JEOPARDY_POINTS.forEach(points => {
                Object.keys(JEOPARDY_CATEGORIES).forEach(categoryKey => {
                    const question = allQuestionsData.find(q => q.category === categoryKey && q.points === points);

                    if (question) {
                        availableQuestions[points] = availableQuestions[points] || {};
                        availableQuestions[points][categoryKey] = {
                            ...question,
                            answered: answeredQuestions[`${categoryKey}_${points}`] || false
                        };
                    }
                });
            });
        }

        function renderJeopardyBoard() {
            const boardContainer = document.getElementById('jeopardyBoard');
            const categories = Object.keys(JEOPARDY_CATEGORIES);
            
            document.getElementById('questionDisplay').classList.add('hidden');
            document.getElementById('questionDisplay').classList.remove('flex');
            boardContainer.classList.remove('hidden');

            let isCategoryTitle = true;
            boardContainer.innerHTML = ''; 

            // 1. Re-renderizar Títulos de Categoría (Usa los nombres CORREGIDOS del JS)
            Object.values(JEOPARDY_CATEGORIES).forEach(title => {
                const titleDiv = document.createElement('div');
                titleDiv.className = 'p-3 bg-trivia-teal font-extrabold text-xl text-center rounded-t-lg text-white';
                titleDiv.textContent = title;
                boardContainer.appendChild(titleDiv);
            });


            // 2. Renderizar Celdas de Puntos 
            JEOPARDY_POINTS.forEach(points => {
                categories.forEach(categoryKey => {
                    const questionData = availableQuestions[points] ? availableQuestions[points][categoryKey] : null;

                    const cell = document.createElement('button');
                    cell.className = 'point-cell question-card bg-trivia-teal text-3xl font-extrabold rounded-lg p-3 m-1 text-white';
                    cell.textContent = `$${points}`;
                    cell.dataset.category = categoryKey;
                    cell.dataset.points = points;
                    
                    if (questionData && questionData.answered) {
                        cell.classList.add('answered', 'bg-gray-700');
                        cell.textContent = ''; 
                        cell.disabled = true;
                    } else if (questionData) {
                            cell.addEventListener('click', () => showQuestion(categoryKey, points));
                            cell.classList.add('hover:bg-teal-600'); 
                    } else {
                            cell.classList.add('bg-gray-700', 'answered');
                            cell.textContent = '';
                            cell.disabled = true;
                    }

                    boardContainer.appendChild(cell);
                });
            });

            document.getElementById('questionDisplay').classList.add('hidden');
            boardContainer.classList.remove('hidden');
        }

        function showQuestion(categoryKey, points) {
            if (questionsAnswered >= MAX_QUESTIONS) {
                endJeopardyGame();
                return;
            }
            
            activeQuestion = availableQuestions[points][categoryKey];

            if (!activeQuestion || activeQuestion.answered) {
                    renderJeopardyBoard();
                    return;
            }
            
            document.getElementById('jeopardyBoard').classList.add('hidden');
            
            const display = document.getElementById('questionDisplay');
            display.classList.remove('hidden');
            display.classList.add('flex');

            document.getElementById('questionCategory').textContent = JEOPARDY_CATEGORIES[categoryKey];
            document.getElementById('questionValue').textContent = `VALOR: $${activeQuestion.points}`;
            document.getElementById('currentQuestionText').textContent = activeQuestion.question;
            document.getElementById('feedbackMessage').classList.add('hidden');
            document.getElementById('backToBoardButton').classList.add('hidden');
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = activeQuestion.options.map((option, index) => `
                <button data-answer="${option}" 
                            data-category="${categoryKey}" 
                            data-points="${points}"
                            class="trivia-option-button w-full text-left p-3 bg-gray-300 hover:bg-yellow-400 text-gray-900 rounded-md transition duration-150 text-base">
                    ${String.fromCharCode(65 + index)}. ${option}
                </button>
            `).join('');

            document.querySelectorAll('.trivia-option-button').forEach(button => {
                button.addEventListener('click', handleAnswer);
            });
        }


        function handleAnswer(event) {
            questionsAnswered++; 
            
            const button = event.target;
            const userAnswer = button.dataset.answer;
            const categoryKey = button.dataset.category;
            const points = parseInt(button.dataset.points);
            
            const question = availableQuestions[points][categoryKey];
            const correct = question.answer;

            document.querySelectorAll('.trivia-option-button').forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-yellow-600');
                btn.classList.remove('text-gray-900'); 
                btn.classList.add('text-white');
                
                if (btn.dataset.answer === correct) {
                    btn.classList.add('bg-green-600'); 
                } else if (btn.dataset.answer === userAnswer) {
                    btn.classList.add('bg-red-600'); 
                } else {
                    btn.classList.add('bg-gray-500'); 
                }
            });

            const feedback = document.getElementById('feedbackMessage');
            feedback.classList.remove('hidden', 'text-green-400', 'text-red-400');
            
            if (userAnswer === correct) {
                currentScore += points;
                feedback.textContent = `¡CORRECTO! Ganaste $${points} puntos.`;
                feedback.classList.add('text-green-600');
            } else {
                currentScore -= points;
                feedback.textContent = `INCORRECTO. La respuesta correcta era: ${correct}.`;
                feedback.classList.add('text-red-600');
            }

            question.answered = true;
            answeredQuestions[`${categoryKey}_${points}`] = true; 
            document.getElementById('currentScore').textContent = currentScore;
            
            if (questionsAnswered >= MAX_QUESTIONS) {
                setTimeout(endJeopardyGame, 2000); // Wait 2 seconds before showing final score
            } else {
                    document.getElementById('backToBoardButton').classList.remove('hidden');
            }
        }
        
        function endJeopardyGame() {
            document.getElementById('jeopardyOverlay').classList.add('hidden');
            document.getElementById('questionDisplay').classList.add('hidden');
            
            document.getElementById('finalScoreValue').textContent = currentScore;
            document.getElementById('finalScoreOverlay').classList.remove('hidden');
        }


        function init() {
            try {
                scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x0d0d1a, 0.003); 

                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 50, ORBIT_RADIUS); 
                
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio > 1 ? 2 : 1);
                renderer.domElement.classList.add('webgl-canvas'); 
                
                const container = document.getElementById('container');
                if (container) {
                        container.appendChild(renderer.domElement);
                } else {
                        console.error("El contenedor #container no se encontró. No se puede iniciar Three.js.");
                        showMessage("Error crítico: No se encontró el contenedor 3D.", 5000, new THREE.Color(0xff0000));
                        return; 
                }
                
                ambientLight = new THREE.AmbientLight(0x404040, 0.5); 
                scene.add(ambientLight);

                createInitialSun(); 
                createStarField(); 
                
                window.addEventListener('resize', onWindowResize, false);
                setupPointerControls(renderer.domElement);

                document.getElementById('clearButton').addEventListener('click', clearSimulation);
                document.getElementById('triviaButton').addEventListener('click', startJeopardy);
                document.getElementById('resumeButton').addEventListener('click', resumeSimulation);
                document.getElementById('backToBoardButton').addEventListener('click', renderJeopardyBoard);
                document.getElementById('returnToSimButton').addEventListener('click', resumeSimulation); 
                
                populateCatalog();
                generateDynamicQuestions();
                
            } catch (e) {
                console.error("Fallo durante la inicialización de Three.js:", e);
                showMessage(`Error de inicialización: ${e.message}`, 5000, new THREE.Color(0xff0000));
            }
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            if (starField) {
                starField.rotation.y += 0.00005; 
            }

            if (!isPaused) {
                for (let i = planets.length - 1; i >= 0; i--) {
                    const planet = planets[i];

                    calculateGravity(planet);
                    updatePhysics(planet, TIME_STEP);
                    
                    if (planet.mesh.position.length() > MAX_EXPULSION_DISTANCE) {
                        scene.remove(planet.mesh);
                        scene.remove(planet.trail);
                        planets.splice(i, 1);
                        updateAudioVolumes();
                        showMessage('¡Planeta Escapado! Limpiado.', 1000, new THREE.Color(0xff4444));
                        continue;
                    }

                    const orbitPositions = planet.orbitPositions;
                    const positionsAttribute = planet.trail.geometry.attributes.position;
                    const colorsAttribute = planet.trail.geometry.attributes.color;
                    const positionsForDrawing = positionsAttribute.array;
                    const colorsForDrawing = colorsAttribute.array;
                    
                    const index = planet.trailIndex * 3;

                    orbitPositions[index] = planet.mesh.position.x;
                    orbitPositions[index + 1] = planet.mesh.position.y;
                    orbitPositions[index + 2] = planet.mesh.position.z;

                    planet.trailIndex = (planet.trailIndex + 1) % planet.trailLength;
                    
                    if (planet.trailCount < planet.trailLength) {
                        planet.trailCount++;
                    }

                    let p_index = 0; 
                    const totalPoints = planet.trailCount < planet.trailLength ? planet.trailCount : planet.trailLength;
                    const baseColor = planet.planetColor;

                    const updatePoint = (j, opacityRatio) => {
                        positionsForDrawing[p_index * 3] = orbitPositions[j * 3];
                        positionsForDrawing[p_index * 3 + 1] = orbitPositions[j * 3 + 1];
                        positionsForDrawing[p_index * 3 + 2] = orbitPositions[j * 3 + 2];
                        
                        colorsForDrawing[p_index * 4] = baseColor.r;
                        colorsForDrawing[p_index * 4 + 1] = baseColor.g;
                        colorsForDrawing[p_index * 4 + 2] = baseColor.b;
                        colorsForDrawing[p_index * 4 + 3] = opacityRatio;

                        p_index++;
                    };
                    
                    const calculateOpacity = (i) => {
                        const minOpacity = 0.2;
                        const factor = 1.0 - minOpacity;
                        return minOpacity + (i / totalPoints) * factor; 
                    };

                    if (planet.trailCount < planet.trailLength) {
                        for (let j = 0; j < planet.trailCount; j++) {
                            const opacityRatio = calculateOpacity(j);
                            updatePoint(j, opacityRatio);
                        }
                        planet.trail.geometry.setDrawRange(0, planet.trailCount);

                    } else {
                        let opacityCounter = 0;
                        
                        for (let j = planet.trailIndex; j < planet.trailLength; j++) {
                            const opacityRatio = calculateOpacity(opacityCounter++);
                            updatePoint(j, opacityRatio);
                        }
                        for (let j = 0; j < planet.trailIndex; j++) {
                            const opacityRatio = calculateOpacity(opacityCounter++);
                            updatePoint(j, opacityRatio);
                        }
                        
                        planet.trail.geometry.setDrawRange(0, planet.trailLength);
                    }

                    positionsAttribute.needsUpdate = true;
                    colorsAttribute.needsUpdate = true;
                }
            }
            
            const ORBIT_RADIUS = 400; 
            const DAMPING_FACTOR = 0.9; 

            if (!isDragging) {
                theta += velocityX;
                phi -= velocityY; 
                velocityX *= DAMPING_FACTOR;
                velocityY *= DAMPING_FACTOR;
            }

            phi = Math.max(0.1, Math.min(Math.PI - 0.1, phi));

            const x = ORBIT_RADIUS * Math.sin(phi) * Math.sin(theta);
            const y = ORBIT_RADIUS * Math.cos(phi);
            const z = ORBIT_RADIUS * Math.sin(phi) * Math.cos(theta);

            camera.position.set(x, y, z);
            camera.lookAt(0, 0, 0); 

            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }


        // =================================================================
        // ENLACE FINAL DEL BOTÓN (DOM Ready)
        // =================================================================

        // Variables para el soporte táctil (tocar para colocar)
        let touchTarget = null; 
        let longPressTimeout = null; 

        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. INICIALIZADOR PRINCIPAL - INICIO AUTOMÁTICO
            const overlay = document.getElementById('overlay');
            
            // Inicia la opacidad a 1 y luego comienza la transición de inicio automático
            overlay.style.opacity = '1';

            // TIEMPO DE ESPERA ANTES DE INICIAR LA SIMULACIÓN AUTOMÁTICAMENTE (3 segundos)
            setTimeout(() => {
                try {
                    // 1. INICIALIZACIÓN CRÍTICA (Se eliminó la reproducción automática de audio)
                    init();
                    animate();
                    
                    // 2. OCULTAR OVERLAY
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        overlay.style.display = 'none'; // Quita la capa para liberar el toque
                    }, 500);

                    // 3. MUESTRA CONTROLES
                    document.getElementById('controls').style.opacity = '1';
                    document.getElementById('controls').style.pointerEvents = 'auto'; 
                    document.getElementById('planetCatalog').style.opacity = '1';
                    document.getElementById('planetCatalog').style.pointerEvents = 'auto'; 

                    showMessage('¡Simulación Iniciada! Arrastra un planeta para crear su órbita.', 3500, new THREE.Color(0x22c55e));
                    
                } catch (error) {
                    console.error("Fallo crítico durante el inicio automático:", error);
                    showMessage(`Error de inicio: ${error.message}. La simulación no pudo cargarse.`, 6000, new THREE.Color(0xff0000));
                }
            }, 3000); // <-- 3 segundos de pausa en la pantalla de bienvenida


            // 2. LÓGICA DE ARRASTRAR Y SOLTAR (DRAG & DROP) UNIFICADA
            const catalogList = document.getElementById('catalogList');
            const canvasContainer = document.getElementById('container');
            let draggedPlanetData = null;
            let ghostElement = null;

            if (catalogList && canvasContainer) {
                catalogList.addEventListener('pointerdown', (e) => {
                    const item = e.target.closest('.catalog-item');
                    if (!item) return;

                    // Previene comportamientos por defecto como la selección de texto
                    if (e.pointerType === 'mouse') {
                       e.preventDefault();
                    }
                    
                    const index = item.dataset.planetIndex;
                    if (index === undefined) return;

                    draggedPlanetData = SOLAR_SYSTEM_PLANETS[index];

                    // Crea y estiliza el elemento fantasma que sigue al puntero
                    ghostElement = item.cloneNode(true);
                    ghostElement.style.position = 'absolute';
                    ghostElement.style.pointerEvents = 'none';
                    ghostElement.style.zIndex = '1000';
                    document.body.appendChild(ghostElement);
                    
                    ghostElement.classList.add('dragging'); // Re-aplica la clase para el estilo
                    item.classList.add('opacity-50'); // Atenúa el original
                    
                    // Posiciona el fantasma en el cursor
                    ghostElement.style.left = `${e.clientX - ghostElement.offsetWidth / 2}px`;
                    ghostElement.style.top = `${e.clientY - ghostElement.offsetHeight / 2}px`;
                });

                document.addEventListener('pointermove', (e) => {
                    if (draggedPlanetData && ghostElement) {
                        ghostElement.style.left = `${e.clientX - ghostElement.offsetWidth / 2}px`;
                        ghostElement.style.top = `${e.clientY - ghostElement.offsetHeight / 2}px`;
                    }
                });

                document.addEventListener('pointerup', (e) => {
                    if (draggedPlanetData && ghostElement) {
                        const canvasBounds = canvasContainer.getBoundingClientRect();
                        if (
                            e.clientX >= canvasBounds.left && e.clientX <= canvasBounds.right &&
                            e.clientY >= canvasBounds.top && e.clientY <= canvasBounds.bottom
                        ) {
                            createPlanetFromCatalog(e, draggedPlanetData);
                        }

                        // Limpieza
                        document.body.removeChild(ghostElement);
                        ghostElement = null;
                        draggedPlanetData = null;
                        
                        document.querySelectorAll('.catalog-item.opacity-50').forEach(el => el.classList.remove('opacity-50'));
                    }
                });
            }
            
            // 3. LÓGICA DEL BOTÓN DE OCULTAR PANEL DE INFO (Para móvil)
            const infoPanel = document.getElementById('infoPanel');
            const toggleButton = document.createElement('button');
            toggleButton.id = 'toggleInfoPanel';
            toggleButton.textContent = 'Ocultar ↑';
            toggleButton.className = 'absolute top-0 right-0 mt-1 mr-2 bg-white/20 text-white rounded-full px-3 py-1 text-xs font-semibold transition hover:bg-white/40 focus:outline-none sm:hidden';

            if (infoPanel) {
                 infoPanel.appendChild(toggleButton);
            }
            

            toggleButton.addEventListener('click', () => {
                const controls = document.getElementById('controls');
                let isHidden = infoPanel.style.transform === 'translateY(80%)';

                if (!isHidden) {
                    // CÓDIGO PARA OCULTAR/PLEGAR PANEL
                    infoPanel.style.transform = 'translateY(80%)';
                    infoPanel.style.opacity = '0.7';
                    toggleButton.textContent = 'Mostrar ↓';
                    
                    // MUEVE LOS BOTONES HACIA ABAJO (se pliegan a 180px)
                    controls.style.bottom = '180px'; 
                } else {
                    // CÓDIGO PARA MOSTRAR/DESPLEGAR PANEL
                    infoPanel.style.transform = 'translateY(0)';
                    infoPanel.style.opacity = '1';
                    toggleButton.textContent = 'Ocultar ↑';
                    
                    // MUEVE LOS BOTONES DE VUELTA A SU POSICIÓN ORIGINAL
                    controls.style.bottom = '300px'; 
                }
            });
            
        });
    </script>
</body>
</html>

